<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Faust architecture: disconnect</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Faust architecture
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">disconnect</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="md__2home_2xox_2Sync_2Fadeli2_2pfx_2share_2faust_2android_2app_2oboe_2docs_2notes_2README.html">Oboe Docs Home</a></p>
<h1><a class="anchor" id="autotoc_md114"></a>
Tech Note: Disconnected Streams and Plugin Issues</h1>
<p>When Oboe is using <b>OpenSL ES</b>, and a headset is plugged in or out, then OpenSL ES will automatically switch between devices. This is convenient but can cause problems because the new device may have different burst sizes and different latency.</p>
<p>When Oboe is using <b>AAudio</b>, and a headset is plugged in or out, then the stream is no longer available and becomes "disconnected". The app should then be notified in one of two ways.</p>
<p>1) If the app is using an error callback then the AudioStreamErrorCallback methods will be called. It will launch a thread, which will call onErrorBeforeClose(). Then it stops and closes the stream. Then onErrorAfterClose() will be called. An app may choose to reopen a stream in the onErrorAfterClose() method.</p>
<p>2) If an app is using read()/write() calls then they will return an error when a disconnect occurs. The app should then stop() and close() the stream. An app may then choose to reopen a stream.</p>
<h2><a class="anchor" id="autotoc_md115"></a>
Workaround for not Disconnecting Properly</h2>
<p>On some versions of Android P the disconnect message does not reach AAudio and the app will not know that the device has changed. There is a "Test Disconnects" option in <a href="https://github.com/google/oboe/tree/master/apps/OboeTester/docs">OboeTester</a> that can be used to diagnose this problem.</p>
<p>As a workaround you can listen for a Java <a href="https://developer.android.com/reference/android/content/Intent#ACTION_HEADSET_PLUG">Intent.ACTION_HEADSET_PLUG</a>, which is fired when a head set is plugged in or out. If your min SDK is LOLLIPOP or later then you can use <a href="https://developer.android.com/reference/android/media/AudioManager#ACTION_HEADSET_PLUG">AudioManager.ACTION_HEADSET_PLUG</a> instead. </p><pre class="fragment">// Receive a broadcast Intent when a headset is plugged in or unplugged.
public class PluginBroadcastReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        // Close the stream if it was not disconnected.
    }
}

private BroadcastReceiver mPluginReceiver = new PluginBroadcastReceiver();
</pre><p> You can register for the Intent when your app resumes and unregister when it pauses. </p><pre class="fragment">@Override
public void onResume() {
    super.onResume();
    IntentFilter filter = new IntentFilter(Intent.ACTION_HEADSET_PLUG);
    this.registerReceiver(mPluginReceiver, filter);
}

@Override
public void onPause() {
    this.unregisterReceiver(mPluginReceiver);
    super.onPause();
}
</pre> <h2><a class="anchor" id="autotoc_md116"></a>
Internal Notes</h2>
<ul>
<li>Oboe Issues<ul>
<li><a href="https://github.com/google/oboe/issues/381">#381</a> Connecting headphones does not trigger any event. S9</li>
<li><a href="https://github.com/google/oboe/issues/893">#893</a> onErrorBeforeClose and onErrorAfterClose not called, S10</li>
<li><a href="https://github.com/google/oboe/issues/908">#908</a> Huawei MAR-LX3A</li>
</ul>
</li>
<li>This issue is tracked internally as b/111711159.</li>
<li>A fix in AOSP is <a href="https://android-review.googlesource.com/c/platform/frameworks/av/+/836184">here</a></li>
<li>A fix was also merged into pi-dev on July 30, 2018.</li>
</ul>
<h3><a class="anchor" id="autotoc_md117"></a>
Results from Test Disconnect in OboeTester</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Device   </th><th class="markdownTableHeadLeft">Build   </th><th class="markdownTableHeadLeft">Result    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Pixel 1   </td><td class="markdownTableBodyLeft">QQ1A.190919.002   </td><td class="markdownTableBodyLeft">ALL PASS    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Samsung S10e   </td><td class="markdownTableBodyLeft">PPR1.180610.011   </td><td class="markdownTableBodyLeft">MMAP Output plugIN failed    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Huawei MAR-LX3A   </td><td class="markdownTableBodyLeft">10.0.0.216   </td><td class="markdownTableBodyLeft">MMAP In/Out fails, Legacy In fails.   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
