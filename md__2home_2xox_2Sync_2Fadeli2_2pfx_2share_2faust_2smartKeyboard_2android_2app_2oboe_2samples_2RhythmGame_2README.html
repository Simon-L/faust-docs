<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Faust architecture: Rhythm Game sample</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Faust architecture
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Rhythm Game sample</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This sample demonstrates how to build a simple musical game. The objective of the game is to clap in time to a song by copying what you hear. You do this by listening to the clap sounds, then tapping on the screen to copy those claps.</p>
<p>For a step-by-step guide on how this game works and how to build it check out this codelab: <a href="https://developer.android.com/codelabs/musicalgame-using-oboe">Build a Musical Game using Oboe</a>.</p>
<h1><a class="anchor" id="autotoc_md645"></a>
Screenshots</h1>
<p>The <a class="el" href="structUI.html">UI</a> is deliberately very simple - just tap anywhere in the grey area after hearing the claps. The <a class="el" href="structUI.html">UI</a> will change color to indicate the game state. The colors are:</p>
<ul>
<li>Yellow: <a class="el" href="classGame.html">Game</a> is loading (assets are being decompressed)</li>
<li>Grey: <a class="el" href="classGame.html">Game</a> is being played</li>
<li>Orange: You tapped too early</li>
<li>Green: You tapped on time</li>
<li>Purple: You tapped too late</li>
<li>Red: There was a problem loading the game (check logcat output)</li>
</ul>
<p><img src="images/RhythmGame-screenshot.png" alt="RhythmGame Screenshot" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md646"></a>
Audio timeline</h2>
<p><img src="images/1-timeline.png" alt="Game timeline" title="Game timeline" class="inline"/></p>
<p>The game plays the clap sounds on the first 3 beats of the bar. These are played in time with the backing track.</p>
<p>When the user taps on the screen, a clap sound is played and the game checks whether the tap occurred within an acceptable time window.</p>
<h2><a class="anchor" id="autotoc_md647"></a>
Architecture</h2>
<p><img src="images/2-architecture.png" alt="Game architecture" title="Game architecture" class="inline"/></p>
<p>Oboe provides the <a href="https://github.com/google/oboe/blob/master/include/oboe/AudioStream.h"><code>AudioStream</code></a> class and associated objects to allow the sample to output audio data to the audio device. All other objects are provided by the sample.</p>
<p>Each time the <code>AudioStream</code> needs more audio data it calls <a href="https://github.com/google/oboe/blob/master/include/oboe/AudioStreamCallback.h"><code>AudioDataCallback::onAudioReady</code></a>. This passes a container array named <code>audioData</code> to the <code><a class="el" href="classGame.html">Game</a></code> object which must then fill the array with <code>numFrames</code> of audio frames.</p>
<p><img src="images/3-audioData.png" alt="onAudioReady signature" title="onAudioReady signature" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md648"></a>
Latency optimizations</h2>
<p>The sample uses the following optimizations to obtain a low latency audio stream:</p>
<ul>
<li>Performance mode set to <a href="https://github.com/google/oboe/blob/master/FullGuide.md#setting-performance-mode">Low Latency</a></li>
<li>Sharing mode set to <a href="https://github.com/google/oboe/blob/master/FullGuide.md#sharing-mode">Exclusive</a></li>
<li>Buffer size set to twice the number of frames in a burst (double buffering)</li>
</ul>
<h2><a class="anchor" id="autotoc_md649"></a>
Audio rendering</h2>
<p>The <code><a class="el" href="classIRenderableAudio.html">IRenderableAudio</a></code> interface (abstract class) represents objects which can produce frames of audio data. The <code><a class="el" href="classPlayer.html">Player</a></code> and <code><a class="el" href="classMixer.html">Mixer</a></code> objects both implement this interface.</p>
<p>Both the clap sound and backing tracks are represented by <code><a class="el" href="classPlayer.html">Player</a></code> objects which are then mixed together using a <code><a class="el" href="classMixer.html">Mixer</a></code>.</p>
<p><img src="images/4-audio-rendering.png" alt="Audio rendering" title="Audio rendering" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md650"></a>
Sharing objects with the audio thread</h2>
<p>It is very important that the audio thread (which calls the <code>onAudioReady</code> method) is never blocked. Blocking can cause underruns and audio glitches. To avoid blocking we use a <code><a class="el" href="classLockFreeQueue.html">LockFreeQueue</a></code> to share information between the audio thread and other threads. The following diagram shows how claps are enqueued by pushing the clap times (in milliseconds) onto the queue, then dequeuing the clap time when the clap is played.</p>
<p><img src="images/5-lockfreequeue.png" alt="Lock free queue" title="Lock free queue" class="inline"/></p>
<p>We also use <a href="http://en.cppreference.com/w/cpp/atomic/atomic">atomics</a> to ensure that threads see a consistent view of any shared primitives.</p>
<h2><a class="anchor" id="autotoc_md651"></a>
Keeping UI events and audio in sync</h2>
<p>When a tap event arrives on the <a class="el" href="structUI.html">UI</a> thread it only contains the time (milliseconds since boot) that the event occurred. We need to figure out what the song position was when the tap occurred.</p>
<p>To do this we keep track of the song position and the time it was last updated. These values are updated each time the <code>onAudioReady</code> method is called. This enables us to keep the <a class="el" href="structUI.html">UI</a> in sync with the audio timeline.</p>
<p><img src="images/6-audio-ui-sync.png" alt="Audio/UI synchronization" title="Audio/UI synchronization" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md652"></a>
Calculating whether a tap was successful</h2>
<p>Once we know when the user tapped in the song, we can calculate whether that tap was successful i.e whether it fell within an acceptable time range. This range is known as the "tap window".</p>
<p><img src="images/7-tap-window.png" alt="Tap window calculation" title="Tap window calculation" class="inline"/></p>
<p>Once we know the result of the tap the <a class="el" href="structUI.html">UI</a> is updated with a color to give the user visual feedback. This is done in <code>getTapResult</code>.</p>
<p>Note that once a tap has been received the tap window is removed from the queue - the user only gets one chance to get their tap right!</p>
<h2><a class="anchor" id="autotoc_md653"></a>
Use of compressed audio assets</h2>
<p>In order to reduce APK size this game uses MP3 files for its audio assets. These are extracted on game startup in <code>AAssetDataSource::newFromCompressedAsset</code>. A yellow screen will be shown during this process.</p>
<p>By default the game uses <code><a class="el" href="classNDKExtractor.html">NDKExtractor</a></code> for asset extraction and decoding. Under the hood this uses the <a href="https://developer.android.com/ndk/reference/group/media">NDK Media APIs</a>.</p>
<p>There are some limitations with this approach:</p>
<ul>
<li>Only available on API 21 and above</li>
<li>No resampling: The extracted output format will match the input format of the MP3. In this case a sample rate of 48000. If your audio stream's sample rate doesn't match the assets will not be extracted and an error will be displayed in logcat.</li>
<li>16-bit output only.</li>
</ul>
<p>A faster, more versatile solution is to use <a href="https://www.ffmpeg.org/">FFmpeg</a>. To do this follow <a href="https://medium.com/@donturner/using-ffmpeg-for-faster-audio-decoding-967894e94e71">the instructions here</a> and use the <code>ffmpegExtractor</code> build variant found in <code>app.gradle</code>. The extraction will then be done by <code>FFmpegExtractor</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
